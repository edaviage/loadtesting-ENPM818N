AWSTemplateFormatVersion: "2010-09-09"
Description: CloudFormation template to create a VPC for load testing exercise

Resources:
  # Create a VPC
  LoadTestingVPC:
    Type: AWS::EC2::VPC
    Properties: 
      CidrBlock: 10.0.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags: 
        - Key: Name
          Value: loadtesting-exercise-vpc

  # Create an Internet Gateway
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties: 
      Tags: 
        - Key: Name
          Value: loadtesting-exercise-igw

  # Attach the Internet Gateway to the VPC
  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties: 
      VpcId: !Ref LoadTestingVPC
      InternetGatewayId: !Ref InternetGateway

  # Create a public subnet
  PublicSubnet:
    Type: AWS::EC2::Subnet
    Properties: 
      CidrBlock: 10.0.1.0/24
      VpcId: !Ref LoadTestingVPC
      MapPublicIpOnLaunch: true
      AvailabilityZone: !Select [ 0, !GetAZs "" ]
      Tags: 
        - Key: Name
          Value: loadtesting-public-subnet

  # Create a route table for the public subnet
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties: 
      VpcId: !Ref LoadTestingVPC
      Tags: 
        - Key: Name
          Value: loadtesting-public-route-table

  # Create a route to the Internet through the Internet Gateway
  PublicRoute:
    Type: AWS::EC2::Route
    Properties: 
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  # Associate the public route table with the public subnet
  PublicSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties: 
      SubnetId: !Ref PublicSubnet
      RouteTableId: !Ref PublicRouteTable

  # Create a security group for instances in the VPC
  LoadTestingSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties: 
      GroupDescription: Allow HTTP and SSH access
      VpcId: !Ref LoadTestingVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0  # Allow SSH access from anywhere (can restrict for security)
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0  # Allow HTTP access from anywhere
      Tags: 
        - Key: Name
          Value: loadtesting-sg

Outputs:
  VPCId:
    Description: VPC ID
    Value: !Ref LoadTestingVPC

  PublicSubnetId:
    Description: Public Subnet ID
    Value: !Ref PublicSubnet

  InternetGatewayId:
    Description: Internet Gateway ID
    Value: !Ref InternetGateway

  SecurityGroupId:
    Description: Security Group ID
    Value: !Ref LoadTestingSecurityGroup
